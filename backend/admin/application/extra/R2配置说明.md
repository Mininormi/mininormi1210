# Cloudflare R2 存储配置说明

## 配置步骤

### 1. 配置 R2 参数

编辑 `application/extra/r2.php` 文件，填入你的 R2 配置信息：

```php
return [
    'endpoint' => 'https://<account-id>.r2.cloudflarestorage.com',  // R2 Endpoint
    'bucket' => 'yourbucket',                                        // Bucket 名称
    'access_key_id' => 'your_access_key_id',                        // Access Key ID
    'secret_access_key' => 'your_secret_access_key',                // Secret Access Key
    'region' => 'auto',                                              // Region（通常填 auto）
    'cdnurl' => 'https://yourbucket.yourdomain.com',                // CDN 地址（自定义域名或 R2 public bucket 域名）
    'delete_local_after_upload' => false,                           // 上传后是否删除本地文件
    'thumbstyle' => '',                                              // 缩略图样式（可选）
];
```

### 2. 启用 R2 存储

编辑 `application/extra/upload.php` 文件，修改 `storage` 配置：

```php
return [
    'storage' => 'r2',  // 改为 'r2'，使用本地存储则改为 'local'
    // ... 其他配置
];
```

或者通过环境变量设置（推荐）：

在 `.env` 文件中添加：
```
UPLOAD_STORAGE=r2
R2_ENDPOINT=https://<account-id>.r2.cloudflarestorage.com
R2_BUCKET=yourbucket
R2_ACCESS_KEY_ID=your_access_key_id
R2_SECRET_ACCESS_KEY=your_secret_access_key
R2_REGION=auto
R2_CDNURL=https://yourbucket.yourdomain.com
R2_DELETE_LOCAL=false
```

### 3. 配置 R2 Bucket 的 CORS（如果需要前端直传）

如果将来需要实现前端直传功能，需要在 R2 Bucket 设置中配置 CORS：

```json
[
  {
    "AllowedOrigins": ["https://yourdomain.com"],
    "AllowedMethods": ["GET", "PUT", "POST", "DELETE", "HEAD"],
    "AllowedHeaders": ["*"],
    "ExposeHeaders": ["ETag"],
    "MaxAgeSeconds": 3000
  }
]
```

### 4. 配置 R2 Bucket 的公网访问（如果使用 R2 public bucket 域名）

在 Cloudflare Dashboard 中：
1. 进入 R2 → 你的 Bucket → Settings
2. 找到 "Public access" 部分
3. 启用 "Allow Access" 并设置允许的域名

## 工作原理

1. **上传流程**：
   - 文件先上传到服务器本地（`public/uploads/...`）
   - 上传完成后，`R2Storage` 行为类自动将文件同步到 R2
   - 如果配置了 `delete_local_after_upload => true`，会删除本地文件

2. **删除流程**：
   - 删除附件时，`R2Storage` 行为类自动删除 R2 中的对应文件

3. **URL 生成**：
   - 附件 URL 使用配置的 `cdnurl` + `attachment.url` 拼接
   - 例如：`https://yourbucket.yourdomain.com/uploads/2025/12/24/abc123.jpg`

## 注意事项

1. **首次配置后需要重启 PHP-FPM**（如果使用 PHP-FPM）
2. **确保服务器有写入权限**（上传到本地时需要）
3. **确保 R2 配置正确**，否则上传会失败但不会影响本地存储
4. **建议先测试上传小文件**，确认配置正确后再使用
5. **如果使用 `delete_local_after_upload => true`**，请确保 R2 上传成功后再删除本地文件（代码已做错误处理）

## 切换回本地存储

只需修改 `application/extra/upload.php` 中的 `storage` 为 `'local'` 即可。

## 故障排查

1. **上传后文件没有同步到 R2**：
   - 检查 `runtime/log/` 目录下的日志文件
   - 确认 R2 配置是否正确
   - 确认服务器能访问 R2 endpoint

2. **删除附件时 R2 文件没有删除**：
   - 检查日志文件
   - 确认 `upload_delete` hook 是否正常触发

3. **URL 不正确**：
   - 检查 `r2.php` 中的 `cdnurl` 配置
   - 确认 R2 bucket 的公网访问已正确配置
