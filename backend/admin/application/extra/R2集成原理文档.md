# FastAdmin 集成 Cloudflare R2 存储完整原理文档

## 目录
1. [整体架构](#整体架构)
2. [文件结构](#文件结构)
3. [配置说明](#配置说明)
4. [实现原理](#实现原理)
5. [关键代码逻辑](#关键代码逻辑)
6. [数据流程](#数据流程)
7. [注意事项](#注意事项)
8. [常见问题](#常见问题)

---

## 整体架构

### 设计思路
将 Cloudflare R2（S3 兼容）作为 FastAdmin 的内置存储选项，通过 ThinkPHP 的 Behavior（行为）机制钩入上传生命周期，实现：
- **服务器中转模式**：文件先上传到本地服务器，再异步上传到 R2
- **透明切换**：通过配置切换存储类型，无需修改业务代码
- **完整生命周期**：覆盖上传、删除、缩略图等完整流程

### 架构图
```
用户上传文件
    ↓
FastAdmin Upload 类（本地保存）
    ↓
upload_after Hook → R2Storage::uploadAfter()
    ↓
S3Client → AWS Signature V4 → R2 API
    ↓
更新 Attachment.storage = 'r2'
    ↓
（可选）删除本地文件
```

---

## 文件结构

### 1. 配置文件

#### `application/extra/upload.php`
**作用**：全局上传配置，定义存储类型
```php
return [
    'storage' => getenv('UPLOAD_STORAGE') ?: 'r2',  // 'local' 或 'r2'
    // ... 其他配置
];
```

#### `application/extra/r2.php`
**作用**：R2 专用配置
```php
return [
    'endpoint' => 'https://xxx.r2.cloudflarestorage.com',
    'bucket' => 'bucket-name',
    'access_key_id' => 'xxx',
    'secret_access_key' => 'xxx',
    'region' => 'auto',
    'cdnurl' => 'https://xxx.r2.dev',  // 公共访问域名
    'delete_local_after_upload' => false,  // 上传后是否删除本地文件
    'thumbstyle' => '',  // 缩略图样式
];
```

### 2. 核心类文件

#### `application/common/behavior/R2Storage.php`
**作用**：R2 存储行为类，处理上传和删除逻辑
- `uploadConfigInit()`：上传配置初始化钩子
- `uploadAfter()`：上传完成后钩子（核心逻辑）
- `uploadDelete()`：删除附件时钩子

#### `application/common/library/storage/S3Client.php`
**作用**：S3 兼容客户端，实现 AWS Signature V4 签名
- `putObject()`：上传文件
- `deleteObject()`：删除文件
- `initiateMultipartUpload()`：初始化分片上传
- `uploadPart()`：上传分片
- `completeMultipartUpload()`：完成分片上传
- `request()`：执行 HTTP 请求（私有方法）

### 3. 修改的文件

#### `application/tags.php`
**作用**：注册行为钩子
```php
return [
    'upload_config_init' => [
        'app\\common\\behavior\\R2Storage',
    ],
    'upload_after' => [
        'app\\common\\behavior\\R2Storage',
    ],
    'upload_delete' => [
        'app\\common\\behavior\\R2Storage',
    ],
];
```

#### `application/common/library/Upload.php`
**修改点**：
- 在 `upload()` 方法中，从配置读取 `storage` 并保存到 Attachment
- 添加 null 值检查，确保 `storage` 不为空

#### `application/common/model/Attachment.php`
**修改点**：
- `beforeInsert()`：检查 `storage` 字段是否存在
- `getThumbStyleAttr()`：从 R2 配置读取缩略图样式

---

## 配置说明

### 环境变量（可选）
```bash
UPLOAD_STORAGE=r2  # 存储类型：local 或 r2
R2_DELETE_LOCAL=0  # 是否删除本地文件：0 或 1
R2_THUMBSTYLE=     # 缩略图样式
```

### R2 配置获取方式
1. **优先**：从 `application/extra/r2.php` 读取
2. **备选**：从环境变量读取（使用 `getenv()`）

### 配置验证
- `upload.storage` 必须为 `'r2'` 才会触发 R2 逻辑
- `r2.endpoint`、`r2.bucket` 必须存在且非空

---

## 实现原理

### 1. ThinkPHP Behavior 机制
ThinkPHP 通过 `tags.php` 定义行为钩子，在特定时机触发注册的行为类方法。

**关键钩子**：
- `upload_config_init`：上传配置初始化时触发
- `upload_after`：附件保存到数据库后触发
- `upload_delete`：删除附件时触发

### 2. AWS Signature V4
Cloudflare R2 兼容 AWS S3 API，需要使用 AWS Signature V4 进行请求签名。

**签名步骤**：
1. 构建规范请求（Canonical Request）
2. 构建待签名字符串（String to Sign）
3. 计算签名密钥（Signing Key）
4. 计算签名（Signature）
5. 构建 Authorization 头

**关键要求**：
- 必须包含 `x-amz-content-sha256` 头（body 的 SHA256 hash）
- 所有头必须按字母序排序
- 时间戳必须使用 UTC 时间

### 3. 服务器中转模式
文件上传流程：
1. 用户上传 → 本地服务器保存（`public/uploads/...`）
2. `upload_after` 钩子触发 → 读取本地文件
3. S3Client 上传到 R2
4. 更新 `fa_attachment.storage = 'r2'`
5. （可选）删除本地文件

**优势**：
- 兼容现有上传逻辑
- 上传失败时本地文件仍存在
- 可以异步处理

---

## 关键代码逻辑

### 1. R2Storage::uploadAfter() 核心流程

```php
public function uploadAfter($attachment)
{
    // 1. 检查存储类型配置
    $storage = Config::get('upload.storage');
    if (is_null($storage) || $storage === '') {
        $storage = 'local';
    }
    if ($storage !== 'r2') {
        return;  // 不是 R2 存储，跳过
    }
    
    // 2. 加载 R2 配置
    $r2Config = Config::get('r2');
    if (empty($r2Config['endpoint']) || empty($r2Config['bucket'])) {
        return;  // 配置不完整，跳过
    }
    
    // 3. 获取本地文件路径
    $attachmentData = $attachment->getData();
    $url = $attachmentData['url'];  // 如：/uploads/20251224/xxx.png
    $localFilePath = ROOT_PATH . 'public' . $url;
    
    if (!file_exists($localFilePath)) {
        return;  // 本地文件不存在，跳过
    }
    
    // 4. 初始化 S3Client 并上传
    $s3Client = new S3Client(
        $r2Config['access_key_id'],
        $r2Config['secret_access_key'],
        $r2Config['endpoint'],
        $r2Config['region'] ?? 'auto'
    );
    
    $key = ltrim($url, '/');  // 去掉开头的 /
    $mimetype = $attachmentData['mimetype'];
    
    $response = $s3Client->putObject(
        $r2Config['bucket'],
        $key,
        $localFilePath,
        ['ContentType' => $mimetype]
    );
    
    // 5. 上传成功，更新数据库
    if ($response['statusCode'] == 200) {
        $attachment->setAttr('storage', 'r2');
        $attachment->save();
        
        // 6. （可选）删除本地文件
        if (!empty($r2Config['delete_local_after_upload'])) {
            @unlink($localFilePath);
        }
    }
}
```

### 2. S3Client::request() 签名逻辑

```php
private function request($method, $url, $headers = [], $body = null)
{
    // 1. 解析 URL
    $parsedUrl = parse_url($url);
    $host = $parsedUrl['host'];
    $path = $parsedUrl['path'] ?? '/';
    $query = isset($parsedUrl['query']) ? '?' . $parsedUrl['query'] : '';
    
    // 2. 准备请求头
    $date = gmdate('Ymd\THis\Z');
    $dateShort = gmdate('Ymd');
    $requestHeaders = [
        'Host' => $host,
        'Date' => $date,
    ];
    
    // 3. 计算 payload hash（关键！）
    $payloadHash = 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855';  // 空字符串的 SHA256
    if ($body !== null) {
        $payloadHash = hash('sha256', $body);
        $requestHeaders['x-amz-content-sha256'] = $payloadHash;  // 必须添加此头
    } else {
        $requestHeaders['x-amz-content-sha256'] = $payloadHash;
    }
    
    // 4. 合并自定义头
    $requestHeaders = array_merge($requestHeaders, $headers);
    
    // 5. 构建规范请求（Canonical Request）
    ksort($requestHeaders);  // 按字母序排序
    $canonicalHeaders = '';
    $signedHeaders = '';
    foreach ($requestHeaders as $key => $value) {
        $canonicalHeaders .= strtolower($key) . ':' . trim($value) . "\n";
        $signedHeaders .= strtolower($key) . ';';
    }
    $signedHeaders = rtrim($signedHeaders, ';');
    
    $canonicalRequest = $method . "\n"
        . $path . "\n"
        . $query . "\n"
        . $canonicalHeaders . "\n"
        . $signedHeaders . "\n"
        . $payloadHash;
    
    // 6. 构建待签名字符串（String to Sign）
    $stringToSign = "AWS4-HMAC-SHA256\n"
        . $date . "\n"
        . $dateShort . '/' . $this->region . '/s3/aws4_request' . "\n"
        . hash('sha256', $canonicalRequest);
    
    // 7. 计算签名密钥（Signing Key）
    $kDate = hash_hmac('sha256', $dateShort, 'AWS4' . $this->secretAccessKey, true);
    $kRegion = hash_hmac('sha256', $this->region, $kDate, true);
    $kService = hash_hmac('sha256', 's3', $kRegion, true);
    $kSigning = hash_hmac('sha256', 'aws4_request', $kService, true);
    
    // 8. 计算签名
    $signature = hash_hmac('sha256', $stringToSign, $kSigning);
    
    // 9. 构建 Authorization 头
    $authorization = 'AWS4-HMAC-SHA256 '
        . 'Credential=' . $this->accessKeyId . '/' . $dateShort . '/' . $this->region . '/s3/aws4_request, '
        . 'SignedHeaders=' . $signedHeaders . ', '
        . 'Signature=' . $signature;
    
    $requestHeaders['Authorization'] = $authorization;
    
    // 10. 执行 cURL 请求
    // ... cURL 代码 ...
}
```

### 3. 配置加载时机

**问题**：`Config::get('upload.storage')` 可能返回 `null`

**原因**：ThinkPHP 配置加载时机问题，某些情况下配置值可能未正确加载

**解决方案**：
```php
$storage = Config::get('upload.storage');
if (is_null($storage) || $storage === '') {
    $storage = 'local';  // 使用默认值
}
```

### 4. Attachment 模型属性访问

**问题**：直接访问 `$attachment->storage` 可能报错

**原因**：ThinkPHP Model 的属性访问机制，未定义的属性可能不存在

**解决方案**：
```php
// 使用 getData() 方法安全访问
$attachmentData = $attachment->getData();
$url = isset($attachmentData['url']) ? $attachmentData['url'] : '';

// 更新属性使用 setAttr()
$attachment->setAttr('storage', 'r2');
$attachment->save();
```

---

## 数据流程

### 上传流程
```
1. 用户选择文件并上传
   ↓
2. Upload::upload() 方法执行
   - 文件保存到本地：public/uploads/20251224/xxx.png
   - 读取配置：Config::get('upload.storage')
   - 创建 Attachment 记录（storage 字段）
   ↓
3. Attachment::save() 执行
   ↓
4. upload_after Hook 触发
   ↓
5. R2Storage::uploadAfter() 执行
   - 检查 storage === 'r2'
   - 读取本地文件
   - S3Client::putObject() 上传到 R2
   - 更新 Attachment.storage = 'r2'
   - （可选）删除本地文件
   ↓
6. 返回成功响应
```

### 删除流程
```
1. 用户删除附件
   ↓
2. Attachment::delete() 执行
   ↓
3. upload_delete Hook 触发
   ↓
4. R2Storage::uploadDelete() 执行
   - 检查 storage === 'r2'
   - S3Client::deleteObject() 删除 R2 文件
   ↓
5. Attachment 记录删除
```

### 访问流程
```
1. 前端请求图片 URL：/uploads/20251224/xxx.png
   ↓
2. Attachment 模型查询
   - 如果 storage === 'r2'
   - 返回 CDN URL：https://xxx.r2.dev/uploads/20251224/xxx.png
   - 否则返回本地 URL
```

---

## 注意事项

### 1. 配置加载顺序
- `upload.php` 必须在 `r2.php` 之前加载
- 使用 `getenv()` 而不是 `env()`（ThinkPHP 兼容性）

### 2. AWS Signature V4 要求
- **必须**包含 `x-amz-content-sha256` 头
- 所有头必须按字母序排序
- 时间戳必须使用 UTC（`gmdate()`）
- 路径和查询字符串必须正确编码

### 3. 文件路径处理
- R2 的 key 不能以 `/` 开头
- 本地文件路径：`ROOT_PATH . 'public' . $url`
- R2 的 key：`ltrim($url, '/')`

### 4. 错误处理
- 上传失败时记录日志，但不抛出异常（避免影响主流程）
- 本地文件不存在时跳过 R2 上传
- 配置不完整时回退到本地存储

### 5. 数据库字段
- `fa_attachment` 表必须有 `storage` 字段（VARCHAR，默认 'local'）
- 使用 `setAttr()` 更新属性，避免直接赋值

---

## 常见问题

### Q1: 上传后文件没有出现在 R2
**排查步骤**：
1. 检查 `application/extra/upload.php` 中 `storage` 是否为 `'r2'`
2. 检查 `application/extra/r2.php` 配置是否完整
3. 查看 `runtime/log/` 日志文件
4. 检查 S3Client 签名是否正确（特别是 `x-amz-content-sha256` 头）

### Q2: Config::get('upload.storage') 返回 null
**原因**：配置加载时机问题
**解决**：添加 null 检查并使用默认值
```php
$storage = Config::get('upload.storage');
if (is_null($storage) || $storage === '') {
    $storage = 'local';
}
```

### Q3: 类的属性不存在: Attachment->storage
**原因**：直接访问可能不存在的属性
**解决**：使用 `getData()` 和 `setAttr()` 方法
```php
$data = $attachment->getData();
$storage = isset($data['storage']) ? $data['storage'] : 'local';
$attachment->setAttr('storage', 'r2');
```

### Q4: Missing x-amz-content-sha256 错误
**原因**：AWS Signature V4 要求必须包含此头
**解决**：在 `S3Client::request()` 中添加：
```php
$requestHeaders['x-amz-content-sha256'] = $payloadHash;
```

### Q5: 文件上传成功但 URL 还是本地路径
**原因**：前端未使用 CDN URL
**解决**：在 Attachment 模型中处理 URL 转换，或前端直接使用 `cdnurl` 配置

---

## 完整实现检查清单

### 配置文件
- [ ] `application/extra/upload.php` 存在且 `storage` 配置正确
- [ ] `application/extra/r2.php` 存在且配置完整
- [ ] `application/tags.php` 注册了三个钩子

### 核心类
- [ ] `application/common/behavior/R2Storage.php` 存在
- [ ] `application/common/library/storage/S3Client.php` 存在
- [ ] S3Client 实现了 AWS Signature V4 签名
- [ ] S3Client 包含 `x-amz-content-sha256` 头

### 修改的文件
- [ ] `application/common/library/Upload.php` 读取 `storage` 配置
- [ ] `application/common/model/Attachment.php` 支持 `storage` 字段
- [ ] `application/common/model/Attachment.php` 的 `getThumbStyleAttr()` 支持 R2

### 数据库
- [ ] `fa_attachment` 表有 `storage` 字段（VARCHAR，默认 'local'）

### 测试
- [ ] 上传文件后，R2 控制台出现新文件
- [ ] `fa_attachment` 表的 `storage` 字段更新为 `'r2'`
- [ ] 删除附件时，R2 文件也被删除
- [ ] 前端可以正确访问 R2 文件（通过 CDN URL）

---

## 总结

本实现通过 ThinkPHP 的 Behavior 机制，将 Cloudflare R2 无缝集成到 FastAdmin 的上传系统中。关键点：

1. **配置驱动**：通过 `upload.storage` 配置切换存储类型
2. **钩子机制**：使用 `upload_after` 和 `upload_delete` 钩子处理 R2 逻辑
3. **AWS Signature V4**：正确实现签名算法，特别是 `x-amz-content-sha256` 头
4. **错误处理**：完善的错误处理和日志记录
5. **兼容性**：保持与现有上传逻辑的兼容性

按照此文档，可以完整重现整个实现过程。
