# FastAdmin Cloudflare R2 存储集成完整文档

## 目录
1. [概述](#概述)
2. [架构设计](#架构设计)
3. [文件结构](#文件结构)
4. [配置说明](#配置说明)
5. [实现原理](#实现原理)
6. [使用指南](#使用指南)
7. [数据流程](#数据流程)
8. [常见问题](#常见问题)

---

## 概述

### 功能说明
本系统将 Cloudflare R2（S3 兼容）作为 FastAdmin 的内置存储选项，通过 ThinkPHP 的 Behavior（行为）机制钩入上传生命周期，实现文件上传到 R2 云存储。

### 核心特性
- ✅ **服务器中转模式**：文件先上传到本地服务器，再异步上传到 R2
- ✅ **透明切换**：通过后台配置切换存储类型（local/r2），无需修改代码
- ✅ **完整生命周期**：覆盖上传、删除、预览等完整流程
- ✅ **配置化管理**：通过 FastAdmin 系统配置页面管理 R2 设置
- ✅ **自动同步**：上传后自动同步到 R2，删除时同步删除 R2 中的文件

---

## 架构设计

### 设计思路
采用 **服务器中转模式**，文件上传流程如下：

```
用户上传文件
    ↓
FastAdmin Upload 类（保存到本地服务器）
    ↓
upload_after Hook → R2Storage::uploadAfter()
    ↓
S3Client → AWS Signature V4 → R2 API
    ↓
更新 Attachment.storage = 'r2'
    ↓
（可选）删除本地文件
```

### 关键组件
1. **R2Storage Behavior**：处理上传和删除逻辑
2. **S3Client**：S3 兼容客户端，实现 AWS Signature V4 签名
3. **配置系统**：通过 `fa_config` 表管理 R2 配置
4. **前端界面**：根据存储类型动态显示/隐藏上传按钮

---

## 文件结构

### 1. 配置文件

#### `application/extra/r2.php`
**作用**：R2 专用配置（敏感信息，建议使用环境变量）

```php
return [
    'endpoint' => getenv('R2_ENDPOINT') ?: 'https://xxx.r2.cloudflarestorage.com',
    'bucket' => getenv('R2_BUCKET') ?: 'bucket-name',
    'access_key_id' => getenv('R2_ACCESS_KEY_ID') ?: 'xxx',
    'secret_access_key' => getenv('R2_SECRET_ACCESS_KEY') ?: 'xxx',
    'region' => getenv('R2_REGION') ?: 'auto',
    'cdnurl' => getenv('R2_CDNURL') ?: 'https://xxx.r2.dev',
    'delete_local_after_upload' => false,
    'thumbstyle' => '',
];
```

**⚠️ 安全提示**：`access_key_id` 和 `secret_access_key` 应通过环境变量配置，不要硬编码在文件中。

#### `application/extra/upload.php`
**作用**：全局上传配置

```php
return [
    'storage' => getenv('UPLOAD_STORAGE') ?: 'r2',  // 'local' 或 'r2'
    'uploadurl' => 'ajax/upload',
    'cdnurl' => '',
    // ... 其他配置
];
```

### 2. 核心类文件

#### `application/common/behavior/R2Storage.php`
**作用**：R2 存储行为类，处理上传和删除逻辑

**主要方法**：
- `uploadConfigInit(&$upload)`：上传配置初始化钩子，当 `storage=r2` 时修改上传配置
- `uploadAfter($attachment)`：上传完成后钩子，将文件同步上传到 R2（核心逻辑）
- `uploadDelete($attachment)`：删除附件时钩子，同步删除 R2 中的文件

#### `application/common/library/storage/S3Client.php`
**作用**：S3 兼容客户端，实现 AWS Signature V4 签名

**主要方法**：
- `putObject($bucket, $key, $filePath, $options)`：上传文件
- `deleteObject($bucket, $key)`：删除文件
- `initiateMultipartUpload($bucket, $key)`：初始化分片上传
- `uploadPart($bucket, $key, $uploadId, $partNumber, $filePath)`：上传分片
- `completeMultipartUpload($bucket, $key, $uploadId, $parts)`：完成分片上传

### 3. 修改的文件

#### `application/tags.php`
**作用**：注册行为钩子

```php
return [
    'upload_config_init' => [
        'app\\common\\behavior\\R2Storage',
    ],
    'upload_after' => [
        'app\\common\\behavior\\R2Storage',
    ],
    'upload_delete' => [
        'app\\common\\behavior\\R2Storage',
    ],
];
```

#### `application/common/behavior/Common.php`
**作用**：模块初始化时合并 R2 配置到 upload 配置

**关键逻辑**：
- 读取 `fa_config` 表中的 `r2_upload_*` 配置项
- 将 `r2_upload_storage`（select 类型，值为索引）转换为实际值（'local' 或 'r2'）
- 合并到 `upload` 配置中

#### `application/admin/controller/Ajax.php`
**作用**：后台 AJAX 上传控制器

**关键逻辑**：
- 上传前合并 R2 配置
- 设置 `upload.storage` 和 `upload.cdnurl`

#### `application/common/library/Upload.php`
**作用**：核心上传类

**关键逻辑**：
- 从配置数组读取 `storage`（而不是使用 `Config::get('upload.storage')`）
- 保存附件时设置 `storage` 字段

#### `application/admin/view/general/attachment/add.html`
**作用**：附件添加页面模板

**显示逻辑**：
- 当 `storage == 'r2'` 时：只显示"上传到第三方"按钮
- 当 `storage == 'local'` 时：只显示"上传到本地"按钮

---

## 配置说明

### 1. 数据库配置（`fa_config` 表）

R2 配置通过 FastAdmin 系统配置页面管理，存储在 `fa_config` 表中：

| 配置项名称 | 类型 | 说明 | 默认值 |
|-----------|------|------|--------|
| `r2_upload_storage` | select | 存储引擎：local(本地) 或 r2(Cloudflare R2) | local |
| `r2_upload_maxsize` | string | 最大上传大小 | 10mb |
| `r2_upload_mimetype` | string | 允许的文件类型 | jpg,png,bmp,jpeg,gif,webp,zip,rar,wav,mp4,mp3,webm |
| `r2_upload_multiple` | switch | 是否支持批量上传 | false |
| `r2_upload_chunking` | switch | 是否支持分片上传 | false |
| `r2_upload_chunksize` | string | 分片大小 | 2097152 |
| `r2_upload_timeout` | string | 上传超时时间 | 60000 |
| `r2_upload_savekey` | string | 文件保存路径格式 | /rimsurge/uploads/{year}{mon}{day}/{filemd5}{.suffix} |
| `r2_upload_fullmode` | switch | 完整URL模式 | false |
| `r2_upload_thumbstyle` | string | 缩略图样式 | 空 |

**配置位置**：系统配置 → R2配置

### 2. R2 参数配置（`application/extra/r2.php`）

| 参数 | 说明 | 示例 |
|------|------|------|
| `endpoint` | R2 API Endpoint | `https://<account-id>.r2.cloudflarestorage.com` |
| `bucket` | Bucket 名称 | `my-bucket` |
| `access_key_id` | Access Key ID | （从 Cloudflare Dashboard 获取） |
| `secret_access_key` | Secret Access Key | （从 Cloudflare Dashboard 获取） |
| `region` | Region | `auto` |
| `cdnurl` | CDN 地址（公共访问域名） | `https://pub-xxx.r2.dev` 或自定义域名 |
| `delete_local_after_upload` | 上传后是否删除本地文件 | `false` |
| `thumbstyle` | 缩略图样式 | 空字符串 |

**⚠️ 安全提示**：
- `access_key_id` 和 `secret_access_key` 应通过环境变量配置
- 不要将敏感信息提交到版本控制系统

### 3. 环境变量配置（推荐）

在 `.env` 文件中配置：

```env
# 存储类型
UPLOAD_STORAGE=r2

# R2 配置
R2_ENDPOINT=https://<account-id>.r2.cloudflarestorage.com
R2_BUCKET=my-bucket
R2_ACCESS_KEY_ID=your_access_key_id
R2_SECRET_ACCESS_KEY=your_secret_access_key
R2_REGION=auto
R2_CDNURL=https://pub-xxx.r2.dev
```

---

## 实现原理

### 1. 配置合并流程

```
模块初始化 (Common::moduleInit)
    ↓
读取 fa_config 表中的 r2_upload_* 配置
    ↓
转换 r2_upload_storage（索引 → 实际值）
    ↓
合并到 Config::set('upload', $uploadConfig)
    ↓
设置 Config::set('upload.storage', $storageValue)
```

### 2. 上传流程

```
用户点击上传按钮
    ↓
Ajax::upload() 方法
    ↓
Config::load('upload.php') 重置配置
    ↓
合并 R2 配置（从 fa_config）
    ↓
Upload::upload() 读取 storage 配置
    ↓
保存附件到本地（storage 字段写入数据库）
    ↓
upload_after Hook 触发
    ↓
R2Storage::uploadAfter() 检查 storage
    ↓
如果 storage === 'r2'，上传到 R2
    ↓
更新 Attachment.storage = 'r2'
    ↓
（可选）删除本地文件
```

### 3. 删除流程

```
用户删除附件
    ↓
Attachment::delete() 或相关删除方法
    ↓
upload_delete Hook 触发
    ↓
R2Storage::uploadDelete() 检查 storage
    ↓
如果 storage === 'r2'，删除 R2 中的文件
```

### 4. 前端按钮显示逻辑

**模板文件**：`application/admin/view/general/attachment/add.html`

```php
{* 上传到第三方按钮：只在 storage != 'local' 且 cdnurl 存在时显示 *}
{if $config.upload.cdnurl && $config.upload.storage != 'local'}
    <!-- 上传到第三方按钮 -->
{/if}

{* 上传到本地按钮：只在 storage == 'local' 时显示 *}
{if $config.upload.storage == 'local'}
    <!-- 上传到本地按钮 -->
{/if}
```

---

## 使用指南

### 1. 初始配置

#### 步骤 1：配置 R2 参数
编辑 `application/extra/r2.php`，填入 R2 配置信息（建议使用环境变量）。

#### 步骤 2：设置存储引擎
1. 登录 FastAdmin 后台
2. 进入 **系统配置** → **R2配置**
3. 选择 **存储引擎**：`local`（本地）或 `r2`（Cloudflare R2）
4. 配置其他参数（最大上传大小、文件类型等）
5. 保存配置

#### 步骤 3：验证配置
1. 进入 **附件管理** → **添加**
2. 根据选择的存储引擎，应该只显示对应的上传按钮：
   - 选择 `r2`：只显示"上传到第三方"按钮
   - 选择 `local`：只显示"上传到本地"按钮
3. 上传一个测试文件
4. 检查附件列表中的"存储引擎"字段是否正确

### 2. 切换存储类型

**方法 1：通过后台配置**
1. 进入 **系统配置** → **R2配置**
2. 修改 **存储引擎** 选项
3. 保存配置

**方法 2：通过环境变量**
修改 `.env` 文件中的 `UPLOAD_STORAGE` 值：
```env
UPLOAD_STORAGE=r2   # 或 local
```

### 3. 查看上传的文件

#### 在 R2 中查看
1. 登录 Cloudflare Dashboard
2. 进入 **R2** → 选择你的 Bucket
3. 查看上传的文件

#### 在 FastAdmin 中查看
1. 进入 **附件管理**
2. 查看附件列表
3. **存储引擎** 列显示 `r2` 的文件已上传到 R2
4. 点击预览，使用 `cdnurl` 显示文件

---

## 数据流程

### 上传流程详细说明

1. **前端上传请求**
   - 用户选择文件并点击上传按钮
   - JavaScript 发送 POST 请求到 `/ajax/upload`

2. **后端处理（Ajax::upload）**
   ```php
   // 1. 重置配置
   Config::load('upload.php');
   
   // 2. 合并 R2 配置
   $siteConfig = Config::get('site');
   $uploadConfig = Config::get('upload');
   // 转换 r2_upload_storage（索引 → 实际值）
   $uploadConfig['storage'] = 'r2';  // 或 'local'
   Config::set('upload', $uploadConfig);
   ```

3. **文件保存（Upload::upload）**
   ```php
   // 1. 读取 storage 配置
   $uploadConfig = Config::get('upload', []);
   $storage = $uploadConfig['storage'] ?? 'local';
   
   // 2. 保存文件到本地
   $file->move($destDir, $fileName);
   
   // 3. 创建 Attachment 记录
   $attachment = new Attachment();
   $attachment->data([
       'url' => '/uploads/20251226/xxx.jpg',
       'storage' => $storage,  // 'local' 或 'r2'
       // ... 其他字段
   ]);
   $attachment->save();
   ```

4. **R2 上传（R2Storage::uploadAfter）**
   ```php
   // 1. 检查 storage
   if ($attachment->storage === 'local') {
       return;  // 跳过 R2 上传
   }
   
   // 2. 读取 R2 配置
   $r2Config = Config::get('r2');
   
   // 3. 初始化 S3Client
   $s3Client = new S3Client(
       $r2Config['access_key_id'],
       $r2Config['secret_access_key'],
       $r2Config['endpoint'],
       $r2Config['region']
   );
   
   // 4. 上传到 R2
   $response = $s3Client->putObject(
       $r2Config['bucket'],
       'uploads/20251226/xxx.jpg',
       '/path/to/local/file.jpg',
       ['ContentType' => 'image/jpeg']
   );
   
   // 5. 更新数据库
   if ($response['statusCode'] == 200) {
       $attachment->setAttr('storage', 'r2');
       $attachment->setAttr('r2_url', 'https://cdn.example.com/uploads/20251226/xxx.jpg');
       $attachment->save();
   }
   ```

### 删除流程详细说明

1. **用户删除附件**
   - 在附件管理页面点击删除按钮

2. **后端处理（R2Storage::uploadDelete）**
   ```php
   // 1. 检查 storage
   if ($attachment->storage !== 'r2') {
       return;  // 跳过 R2 删除
   }
   
   // 2. 删除 R2 中的文件
   $s3Client = new S3Client(...);
   $s3Client->deleteObject($bucket, $key);
   
   // 3. 删除本地文件（如果存在）
   // 删除数据库记录（由 FastAdmin 处理）
   ```

---

## 常见问题

### 1. 上传后文件仍然显示为 `local`

**原因**：
- `Config::get('upload.storage')` 读取不到正确的值
- 配置合并逻辑未正确执行

**解决方法**：
- 检查日志文件 `runtime/log/YYYYMM/DD.log`，搜索 `[R2 Debug]`
- 确认 `r2_upload_storage` 配置项的值是否正确
- 确认 `Common::moduleInit` 和 `Ajax::upload` 中的配置合并逻辑已执行

### 2. "上传到第三方"按钮不显示

**原因**：
- `upload.cdnurl` 未设置
- `upload.storage` 为 `local`

**解决方法**：
- 在 R2 配置中设置 **CDN地址**
- 确认存储引擎选择为 `r2`

### 3. R2 上传失败

**可能原因**：
- R2 配置不完整（endpoint、bucket、access_key_id、secret_access_key）
- 网络连接问题
- R2 Bucket 权限设置不正确

**解决方法**：
- 检查 `application/extra/r2.php` 配置
- 查看日志文件中的错误信息
- 确认 R2 API Token 有正确的权限

### 4. 文件上传到 R2 但本地文件未删除

**原因**：
- `delete_local_after_upload` 配置为 `false`

**解决方法**：
- 在 `application/extra/r2.php` 中设置 `'delete_local_after_upload' => true`
- 注意：删除本地文件后，预览将使用 R2 CDN URL

### 5. 配置修改后不生效

**原因**：
- 配置缓存未刷新
- `site.php` 文件未更新

**解决方法**：
- 清除缓存：`runtime/cache/` 目录
- 手动刷新配置：在系统配置页面点击"刷新配置"
- 检查 `application/extra/site.php` 文件是否包含最新的配置

---

## 技术细节

### 1. 配置读取方式

由于 ThinkPHP 的 `Config::get('upload.storage')` 可能无法正确读取嵌套配置，代码中采用以下方式：

```php
// 正确方式：从完整配置数组读取
$uploadConfig = Config::get('upload', []);
$storage = $uploadConfig['storage'] ?? 'local';

// 同时设置点号分隔的键，确保兼容性
Config::set('upload.storage', $storage);
```

### 2. Select 类型配置转换

`r2_upload_storage` 是 `select` 类型，数据库中存储的是索引（0 或 1），需要转换为实际值：

```php
$storageValue = $siteConfig['r2_upload_storage'];  // '0' 或 '1'
$configModel = Config::get(['name' => 'r2_upload_storage']);
if ($configModel && $configModel->type === 'select') {
    $content = json_decode($configModel->content, true);  // ['local', 'r2']
    $index = (int)$storageValue;  // 0 或 1
    if (isset($content[$index])) {
        $storageValue = $content[$index];  // 'local' 或 'r2'
    }
}
```

### 3. AWS Signature V4

S3Client 使用 AWS Signature V4 算法对请求进行签名，确保与 R2 API 兼容。签名过程包括：
1. 构建规范请求（Canonical Request）
2. 创建待签名字符串（String to Sign）
3. 计算签名（Signature）
4. 添加到请求头（Authorization Header）

---

## 安全建议

1. **敏感信息保护**
   - 使用环境变量存储 `access_key_id` 和 `secret_access_key`
   - 不要将敏感信息提交到版本控制系统
   - 定期轮换 API Token

2. **权限控制**
   - R2 API Token 应只授予必要的权限（读写指定 Bucket）
   - 使用最小权限原则

3. **访问控制**
   - 配置 R2 Bucket 的 CORS 策略（如果需要前端直传）
   - 使用自定义域名时配置 HTTPS

---

## 更新日志

### 2025-12-26
- ✅ 修复 `Config::get('upload.storage')` 读取问题
- ✅ 实现配置化管理（通过 `fa_config` 表）
- ✅ 优化前端按钮显示逻辑（根据存储类型动态显示/隐藏）
- ✅ 添加详细的调试日志

---

## 相关文件

- `application/common/behavior/R2Storage.php` - R2 存储行为类
- `application/common/library/storage/S3Client.php` - S3 兼容客户端
- `application/extra/r2.php` - R2 配置
- `application/extra/upload.php` - 上传配置
- `application/tags.php` - 行为钩子注册
- `application/common/behavior/Common.php` - 配置合并逻辑
- `application/admin/controller/Ajax.php` - 上传控制器
- `application/common/library/Upload.php` - 核心上传类
- `application/admin/view/general/attachment/add.html` - 上传页面模板

---

**文档版本**：v1.0  
**最后更新**：2025-12-26
